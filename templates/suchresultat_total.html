{% extends "base.html" %}
{% block title %}Suchresultat – Price Hunter{% endblock %}
{% block content %}

<!-- Container für Anzeige der Suchresultate -->
<div class="container-sm">
    <br>
    <h2 class="text-center mb-4">Suchresultat</h2>

    <!-- Tabelle für strukturierte Darstellung der Suchresultate -->
    <div class="table-responsive results-wrap">
        <table id="resultsTable" class="table table-striped table-hover align-middle js-theme-table table-sticky">
            <thead class="table-secondary text-dark">
                <tr>
                    <th>Produkt</th>

                    <!-- Sortierbare Preisspalte -->
                    <th id="sortPreis" class="text-start pe-4" style="cursor:pointer;">
                        Max. Preis <span id="sortSymbol">⬍</span>
                    </th>

                    <!-- Dropdown für die Länderauswahl -->
                    <th>
                        <div class="d-flex align-items-center gap-2" style="vertical-align: middle;">
                            <span class="fw-semibold" style="margin-top: 3px;">Land</span>
                            <select id="filterLand" class="form-select form-select-sm py-0"
                                style="max-width: 140px; height: 28px; line-height: 1;">
                                <option value="">Alle</option>
                            </select>
                        </div>
                    </th>

                    <th class="text-end" style="padding-right: 70px; min-width: 110px;">Link</th>
                </tr>
            </thead>


            <tbody>
                {% for zeile in daten %}
                <tr>
                    <td class="text-truncate" style="max-width: 420px;">
                        <a href="{{ zeile.link }}" class="link-body-emphasis text-decoration-none" target="_blank"
                            rel="noopener" title="{{ zeile.produkt }}">
                            {{ zeile.produkt }}
                        </a>
                    </td>
                    <td class="text-start pe-4">{{ zeile.preis }} {{ zeile.währung or zeile.currency }}</td>
                    <td><span class="badge text-bg-secondary">{{ zeile.region }}</span></td>
                    <td class="text-end">
                        {% if zeile.link %}
                        <a href="{{ zeile.link }}" class="btn btn-sm btn-primary" style="min-width:96px;"
                            target="_blank" rel="noopener">Mehr Info</a>
                        {% else %}
                        <span class="text-muted d-inline-block" style="min-width:96px;">—</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Filter- und Sortier-Java Script -->
<script>
    (function () {
        const table = document.getElementById("resultsTable");
        const tbody = table.querySelector("tbody");
        const filterLand = document.getElementById("filterLand");
        const sortHeader = document.getElementById("sortPreis");
        const sortSymbol = document.getElementById("sortSymbol");
        let sortAsc = true;

        const lands = new Set();
        Array.from(tbody.rows).forEach(tr => {
            const land = tr.cells[2].innerText.trim();
            if (land) lands.add(land);
        });
        [...lands].sort((a, b) => a.localeCompare(b, 'de')).forEach(land => {
            const opt = document.createElement("option");
            opt.value = land;
            opt.textContent = land;
            filterLand.appendChild(opt);
        });

        filterLand.addEventListener("change", () => {
            const selected = filterLand.value;
            Array.from(tbody.rows).forEach(tr => {
                const land = tr.cells[2].innerText.trim();
                tr.style.display = (selected === "" || land === selected) ? "" : "none";
            });
        });

        sortHeader.addEventListener("click", () => {
            const rows = Array.from(tbody.rows);
            rows.sort((a, b) => {
                const priceA = parseFloat(a.cells[1].innerText.replace("CHF", "").replace(",", ".").trim()) || 0;
                const priceB = parseFloat(b.cells[1].innerText.replace("CHF", "").replace(",", ".").trim()) || 0;
                return sortAsc ? priceA - priceB : priceB - priceA;
            });
            rows.forEach(r => tbody.appendChild(r));
            sortSymbol.textContent = sortAsc ? "⬆" : "⬇";
            sortAsc = !sortAsc;
        });
    })();
</script>

{% endblock %}